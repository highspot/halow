<% if (typeof awsError !== 'undefined' && awsError) { %>
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>AWS Connection Issue:</strong> <%= awsError %>
    <br><small>Please configure AWS credentials to view secrets from AWS Secrets Manager.</small>
</div>
<% } %>

<div class="page-header">
    <h2><i class="fas fa-key"></i> AWS Secrets Manager</h2>
    <div class="page-stats">
        <span class="stat">
            <i class="fas fa-shield-alt"></i>
            Total Secrets: <strong><%= totalSecrets %></strong>
        </span>
    </div>
</div>

<!-- Search and Filter Controls -->
<div class="controls-panel">
    <div class="search-section">
        <form method="GET" action="/secrets" class="search-form">
            <div class="search-group">
                <input 
                    type="text" 
                    name="search" 
                    placeholder="Search secrets by name, description, or tags..." 
                    value="<%= searchQuery %>"
                    class="search-input"
                >
                <button type="submit" class="btn btn-search">
                    <i class="fas fa-search"></i> Search
                </button>
                <% if (searchQuery || selectedTag) { %>
                <a href="/secrets" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Clear
                </a>
                <% } %>
            </div>
        </form>
    </div>

    <% if (availableTags.length > 0) { %>
    <div class="filter-section">
        <form method="GET" action="/secrets" class="filter-form">
            <div class="filter-group">
                <label for="tagFilter">Filter by Tag:</label>
                <select name="tag" id="tagFilter" class="filter-select" onchange="this.form.submit()">
                    <option value="">All Tags</option>
                    <% availableTags.forEach(tag => { %>
                    <option value="<%= tag %>" <%= selectedTag === tag ? 'selected' : '' %>>
                        <%= tag %>
                    </option>
                    <% }); %>
                </select>
            </div>
        </form>
    </div>
    <% } %>
</div>

<!-- Secrets List -->
<div class="secrets-container">
    <% if (secrets.length === 0) { %>
    <div class="empty-state">
        <i class="fas fa-key fa-3x"></i>
        <h3>No Secrets Found</h3>
        <% if (searchQuery || selectedTag) { %>
        <p>No secrets match your search criteria.</p>
        <a href="/secrets" class="btn btn-primary">View All Secrets</a>
        <% } else if (typeof awsError === 'undefined' || !awsError) { %>
        <p>No secrets are available in AWS Secrets Manager.</p>
        <% } %>
    </div>
    <% } else { %>
    <div class="secrets-grid">
        <% secrets.forEach(secret => { %>
        <div class="secret-card">
            <div class="secret-header">
                <h4 class="secret-name">
                    <i class="fas fa-shield-alt"></i>
                    <%= secret.name %>
                </h4>
                <div class="secret-actions">
                    <button class="btn btn-sm btn-info" onclick="toggleSecretDetails('<%= secret.name %>')">
                        <i class="fas fa-info-circle"></i> Details
                    </button>
                </div>
            </div>

            <% if (secret.description) { %>
            <div class="secret-description">
                <p><%= secret.description %></p>
            </div>
            <% } %>

            <div class="secret-meta">
                <div class="meta-item">
                    <i class="fas fa-calendar-plus"></i>
                    <strong>Created:</strong> 
                    <%= secret.createdDate ? new Date(secret.createdDate).toLocaleDateString() : 'N/A' %>
                </div>
                <% if (secret.lastChangedDate) { %>
                <div class="meta-item">
                    <i class="fas fa-calendar-edit"></i>
                    <strong>Modified:</strong> 
                    <%= new Date(secret.lastChangedDate).toLocaleDateString() %>
                </div>
                <% } %>
            </div>

            <!-- Tags Section -->
            <div class="secret-tags">
                <div class="tags-header">
                    <i class="fas fa-tags"></i>
                    <strong>Tags (<%= Object.keys(secret.tags).length %>):</strong>
                </div>
                <% if (Object.keys(secret.tags).length === 0) { %>
                <div class="no-tags">
                    <em>No tags assigned</em>
                </div>
                <% } else { %>
                <div class="tags-list">
                    <% Object.entries(secret.tags).forEach(([key, value]) => { %>
                    <div class="tag-item">
                        <span class="tag-key"><%= key %></span>
                        <span class="tag-separator">:</span>
                        <span class="tag-value"><%= value %></span>
                    </div>
                    <% }); %>
                </div>
                <% } %>
            </div>

            <!-- Expandable Details -->
            <div id="details-<%= secret.name %>" class="secret-details" style="display: none;">
                <div class="detail-section">
                    <strong>ARN:</strong>
                    <code class="arn-text"><%= secret.arn %></code>
                </div>
            </div>
        </div>
        <% }); %>
    </div>
    <% } %>
</div>

<script>
function toggleSecretDetails(secretName) {
    const detailsDiv = document.getElementById('details-' + secretName);
    const button = event.target.closest('button');
    
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Details';
    } else {
        detailsDiv.style.display = 'none';
        button.innerHTML = '<i class="fas fa-info-circle"></i> Details';
    }
}

// Auto-submit search form on Enter
document.querySelector('.search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.target.closest('form').submit();
    }
});
</script>